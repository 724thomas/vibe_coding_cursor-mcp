name: PR Auto Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Auto Code Review
      uses: actions/github-script@v6
      with:
        script: |
          const { data: pullRequest } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });

          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });

          let reviewComments = [];
          let suggestions = [];

          // íŒŒì¼ë³„ ìë™ ë¦¬ë·° ì²´í¬
          for (const file of files) {
            // Python íŒŒì¼ì— ëŒ€í•œ ê¸°ë³¸ ì²´í¬
            if (file.filename.endsWith('.py')) {
              if (file.patch) {
                const lines = file.patch.split('\n');
                let lineNumber = 0;

                for (let i = 0; i < lines.length; i++) {
                  const line = lines[i];
                  
                  // ìƒˆë¡œ ì¶”ê°€ëœ ë¼ì¸ë§Œ ì²´í¬ (+ ë¡œ ì‹œì‘)
                  if (line.startsWith('+') && !line.startsWith('+++')) {
                    lineNumber++;
                    
                    // ì½”ë”© ì»¨ë²¤ì…˜ ì²´í¬
                    if (line.includes('print(') && !file.filename.includes('test')) {
                      suggestions.push(`ğŸ” **${file.filename}**: print ë¬¸ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê¹…ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.`);
                    }
                    
                    if (line.length > 127) {
                      suggestions.push(`ğŸ“ **${file.filename}**: ë¼ì¸ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤ (${line.length}ì). 127ì ì´í•˜ë¡œ ì¤„ì´ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.`);
                    }
                    
                    if (line.includes('TODO') || line.includes('FIXME')) {
                      suggestions.push(`ğŸ“ **${file.filename}**: TODO/FIXMEê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ìŠˆë¥¼ ìƒì„±í•˜ì—¬ ì¶”ì í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.`);
                    }
                  }
                }
              }
            }

            // í…ŒìŠ¤íŠ¸ íŒŒì¼ ê´€ë ¨ ì²´í¬
            if (file.filename.includes('test') || file.filename.startsWith('tests/')) {
              if (file.status === 'removed') {
                suggestions.push(`âš ï¸ **í…ŒìŠ¤íŠ¸ íŒŒì¼ ì‚­ì œ**: ${file.filename}ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë ¨ ê¸°ëŠ¥ì´ ì—¬ì „íˆ í…ŒìŠ¤íŠ¸ë˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`);
              }
            }
          }

          // ë³´ì•ˆ ê´€ë ¨ ì²´í¬
          const securityPatterns = [
            { pattern: /password\s*=\s*['"'][^'"]+['"]/, message: 'í•˜ë“œì½”ë”©ëœ íŒ¨ìŠ¤ì›Œë“œê°€ ë°œê²¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' },
            { pattern: /api_key\s*=\s*['"'][^'"]+['"]/, message: 'í•˜ë“œì½”ë”©ëœ API í‚¤ê°€ ë°œê²¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' },
            { pattern: /secret\s*=\s*['"'][^'"]+['"]/, message: 'í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ì´ ë°œê²¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' }
          ];

          files.forEach(file => {
            if (file.patch) {
              securityPatterns.forEach(({ pattern, message }) => {
                if (pattern.test(file.patch)) {
                  suggestions.push(`ğŸ”’ **ë³´ì•ˆ ì£¼ì˜**: ${file.filename}ì—ì„œ ${message}`);
                }
              });
            }
          });

          // ë¦¬ë·° ëŒ“ê¸€ ìƒì„±
          if (suggestions.length > 0) {
            const reviewBody = `
## ğŸ¤– ìë™ ì½”ë“œ ë¦¬ë·°

ë‹¤ìŒ ì‚¬í•­ë“¤ì„ ê²€í† í•´ë³´ì„¸ìš”:

${suggestions.map(s => `- ${s}`).join('\n')}

---
**ì°¸ê³ **: ì´ëŠ” ìë™ ìƒì„±ëœ ë¦¬ë·°ì…ë‹ˆë‹¤. ëª¨ë“  ì œì•ˆì‚¬í•­ì´ ë°˜ë“œì‹œ ìˆ˜ì •ë˜ì–´ì•¼ í•˜ëŠ” ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤.
            `;

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: reviewBody,
              event: 'COMMENT'
            });
          } 